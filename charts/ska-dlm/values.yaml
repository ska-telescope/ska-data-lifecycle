# ------------------------------------------------
# Default Helm configuration for ska-dlm server
# ------------------------------------------------

# ------ Global configuration (shared across components / subcharts) ------
global:
  ingress:
    enabled: false
    domainName: "sdhp.stfc.skao.int"  # required for whitelisting redirects
  development: true
  storageClass: "localdisk"  # existing storage class

  sharedpvc:
    # Shared PVC that can be mounted by multiple pods.
    # Default behaviour assumes the shared PVC is pre-provisioned (e.g. by CI/cluster tooling),
    # to avoid Helm upgrade failures due to immutable PVC fields.
    pv:
      create: false  # PV is cluster-scoped; do not create via Helm by default
      name: shared
      storageSize: 2Gi
      storageClassName: ""  # empty string => no StorageClass (static PV)

    pvc:
      name: shared
      # Default false â€“ assume the shared PVC is pre-created (e.g. by CI/cluster tooling).
      # Set true only for first-time installs into a fresh namespace.
      create: false
      storageSize: 2Gi
      storageClassName: ""  # empty string => no StorageClass (static PVC)

# ------ Chart metadata / naming ------
system: dlm
nameOverride: ""
fullnameOverride: ""


# ------ Core DLM services and API ------

ingest:
  component: ingest
  subsystem: data-lifecycle-management
  image: artefact.skao.int/ska-data-lifecycle
  version: "1.3.2"
  imagePullPolicy: Always
  replicas: 1

storage:
  component: storage
  subsystem: data-lifecycle-management
  image: artefact.skao.int/ska-data-lifecycle
  version: "1.3.2"
  imagePullPolicy: Always
  replicas: 1
  locations:
  endpointSecretName: ""
  endpoints:

migration:
  component: migration
  subsystem: data-lifecycle-management
  image: artefact.skao.int/ska-data-lifecycle
  version: "1.3.2"
  imagePullPolicy: Always
  replicas: 1

request:
  component: request
  subsystem: data-lifecycle-management
  image: artefact.skao.int/ska-data-lifecycle
  version: "1.3.1"
  imagePullPolicy: Always
  replicas: 1

postgrest:
  component: postgrest
  subsystem: data-lifecycle-management
  image: postgrest/postgrest
  version: "v13.0.7"
  imagePullPolicy: Always
  replicas: 1
  db_schema: dlm
  db_anon_role: ska_dlm_admin
  db_pool: 10
  server_host: '*4'
  secret_is_base64: false
  max_rows: ""
  pre_request: ""
  role_claim_key: '.role'
  log_level: info

  # PostgREST's auth details against PostgreSQL come from a Secret, which can be:
  # * Given to us by name, or
  # * Created via:
  #   * VSO, or
  #   * Automatically from the postgresql.auth section
  db_auth_secret:
    create: true  # true for local DB (postgresql.enabled=true)
    vault:
      enabled: false
      path: ""
      mount: ""
      type: "kv-v2"
    name: "" # secret name (for external DB), e.g., for DP cluster: "ska-dlm-dev-postgrest-secret-dp-dm"


# ------ Database options ------

database:
  migration:
    enabled: false  # set to true if building a fresh database
    image: postgres
    version: "17.4"
    base:
      baseInstall: true  # set to true
    patch:
      patchInstall: false  # set to false (our patch migration system is TBD)
      patchVersion: ""  # Supply a valid patch version vx.x.x

postgresql:  # see https://github.com/bitnami/charts/tree/main/bitnami/postgresql
  enabled: false  # whether to deploy a test database
  nameOverride: postgresql

  # Custom user/password/db to create, has to match primary.initdb authentication
  auth:
    username: ska_dlm_admin
    password: password
    database: ska_dlm

  image:
    repository: postgres # docker.io has a pull limit of 100 per 6 hours per IP, 200 for authenticated users
    tag: "17-bookworm"
    pullPolicy: Always  # Always for fresh pulls
    debug: true

  primary:
    name: ska_dlm
    containerSecurityContext:
      readOnlyRootFilesystem: false
    persistence:
      enabled: false
    initdb:
      user: ska_dlm_admin
      password: password
      scriptsConfigMap: ska-dlm-postgresql-initdb-base-scripts
    podLabels:
      component: postgresql
      subsystem: data-lifecycle-management
    networkPolicy:
      enabled: false


# ------ Supporting infrastructure ------

rclone:
  component: rclone
  subsystem: data-lifecycle-management
  image: registry.gitlab.com/ska-telescope/ska-data-lifecycle/ska-data-lifecycle-rclone
  version: 1.3.1
  imagePullPolicy: Always
  replicas: 1
  secret:
    enabled: false
    name: ""
    mountPoint: "/secrets/"
    ssl_key_name: ""
    ssl_cert_name: ""
    vault:
      enabled: false
      mount: ""
      type: kv-v2
      path: ""

gateway:
  enabled: false  # true for DP cluster
  component: gateway
  subsystem: data-lifecycle-management
  image: artefact.skao.int/ska-data-lifecycle-test-gateway
  version: "1.3.2"
  imagePullPolicy: Always
  replicas: 1
  secret:
    name: ""  # supply if gateway.enabled=true, e.g., "gateway-secret"

keycloak:
  enabled: false  # false for production
  component: keycloak
  subsystem: data-lifecycle-management
  image: artefact.skao.int/ska-data-lifecycle-keycloak
  version: "1.3.2"
  imagePullPolicy: Always
  replicas: 1
  use_https: true


# ------ Optional utilities ------

pgweb:  # see https://github.com/ectobit/charts/tree/main/pgweb
  enabled: false  # enable web IDE access to Postgres
  ingress:
    enabled: false
    annotations:
      nginx.ingress.kubernetes.io/rewrite-target: /$2
    hosts:
    - paths:
      - path: /pgweb(/|$)(.*)
        pathType: ImplementationSpecific

benchmark:
  enabled: false  # false for regular deployment. Set to true to run the benchmarking pod (see scripts/README.md)
  component: benchmark
  subsystem: data-lifecycle-management
  image: registry.gitlab.com/ska-telescope/ska-data-lifecycle/ska-data-lifecycle-benchmark
  version: "1.1.2"
  imagePullPolicy: Always
  name: register  # register or migrate
  config:
    host:
    token:
    sourceFile:
    mountPath:

# ------ Auxiliary utility images ------
kubectl:
  image: rancher/kubectl
  version: "v1.28.15-amd64"
  imagePullPolicy: Always